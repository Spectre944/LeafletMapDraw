<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bootstrap Site</title>
    <!-- Include Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">


    <style>
        html,
        body,
        #map {
            height: 100vh;
            width: 100%;
            margin: 0;
            padding: 0;
        }
    </style>

</head>

<body>

    <div class="container-fluid m-0 p-0" style="height: 100vh;">
        <div class="row h-100">
            <div class="col-md-9 h-100">
                <div id="map" style="height: 100%;"></div>
            </div>
            <div class="col-md-3 h-100">
                <div class="table-container h-100 overflow-auto">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Назва</th>
                                <th>Конц.</th>
                                <th>Колір</th>
                                <th>Дії</th>
                                <th>Дії</th>
                            </tr>
                        </thead>
                        <tbody id="polygonTableBody"></tbody>
                    </table>
                </div>

            </div>
        </div>


    </div>


    </div>

    <!-- Modal -->
    <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="staticBackdropLabel">Редагувати полігон</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">

                    <div class="container">
                        <div class="row">
                            <div class="col">
                                Назва
                            </div>
                            <div class="col">
                                Концетрація
                            </div>
                            <div class="col">
                                Колір
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                <select id="inputTypeDanger" class="form-select" aria-label="Default select example">
                                    <option selected>Назва</option>
                                    <option value="1">PED</option>
                                    <option value="2">Arsenic</option>
                                    <option value="3">Phosphorus</option>
                                    <option value="4">HNO</option>
                                    <option value="5">Sulfur</option>
                                    <option value="6">BIO</option>
                                    <option value="7">Hydrocarbon</option>
                                    <option value="8">ChemPro TIC</option>
                                    <option value="9">ChemPro Blister</option>
                                    <option value="10">ChemPro Blood</option>
                                    <option value="11">ChemPro Choking</option>
                                </select>
                            </div>
                            <div class="col">
                                <input type="number" class="form-control" id="concentrationInput">
                            </div>
                            <div class="col">
                                <input type="color" class="form-control form-control-color" id="colorInput"
                                    value="#563d7c" title="Choose your color">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="cancelButton" type="button" class="btn btn-secondary"
                        data-bs-dismiss="modal">Скасувати</button>
                    <button id="saveButton" type="button" class="btn btn-primary">Зберегти</button>
                </div>
            </div>
        </div>
    </div>
</body>

</html>

<!-- Include Bootstrap JavaScript at the end of the body section -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- leaflet js  -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.2/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.2/dist/leaflet.js"></script>

<!-- leaflet draw plugin  -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/0.4.2/leaflet.draw.js"></script>

<!-- leaflet tool bar  -->
<script src="node_modules/leaflet-toolbar/dist/leaflet.toolbar.js"></script>
<link rel="stylesheet" href="node_modules/leaflet-toolbar/dist/leaflet.toolbar.css" />

<script>
    // Initialize the map
    var map = L.map('map').setView([49.83754, 24.031219], 10);

    // After initializing the Leaflet map
    var drawnPolygons = []; // Array to store drawn polygons
    var polygonIdCounter = 1; // Counter variable for polygon IDs

    //for edit data
    var poligonIdEdit = -1;

    // Add the OpenStreetMap tiles
    var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    })
    osm.addTo(map);

    // leaflet draw 
    var drawnFeatures = new L.FeatureGroup();
    map.addLayer(drawnFeatures);

    /*     new L.Toolbar2.Control({
            actions: [MyAction1, MyAction2]
        }).addTo(map); */

    var drawControl = new L.Control.Draw({
        // position: "topright",
        edit: {
            featureGroup: drawnFeatures,
            remove: false
        },
        draw: {
            polygon: {
                shapeOptions: {
                    color: 'purple'
                },
                //  allowIntersection: false,
                //  drawError: {
                //   color: 'orange',
                //   timeout: 1000
                //  },
            },
            polyline: {
                shapeOptions: {
                    color: 'red'
                },
            },
            rect: {
                shapeOptions: {
                    color: 'green'
                },
            },
            circle: {
                shapeOptions: {
                    color: 'steelblue'
                },
            },
        },

    });
    map.addControl(drawControl);

    // Event listener for when a polygon is drawn on the map
    map.on(L.Draw.Event.CREATED, function (event) {
        var layer = event.layer;
        var polygon = layer.toGeoJSON(); // Convert the drawn polygon to GeoJSON format
        //var polygonName = prompt("Enter polygon name:"); // Prompt the user to enter a name for the polygon

        // Assign a unique ID to the polygon
        var polygonId = polygonIdCounter;
        polygonIdCounter++;

        // Store the polygon data in the drawnPolygons array
        drawnPolygons.push({
            id: polygonId,
            name: "-",
            concentration: 0,
            color: "purple",
            layer
        });

        layer.bindPopup(`<p>${JSON.stringify(layer.toGeoJSON())}</p>`)
        //layer.bindPopup(`<p>${layer._leaflet_id}</p>`)
        drawnFeatures.addLayer(layer);

        // Update the table with the polygon data
        updatePolygonTable();
    });

    map.on("draw:edited", function (e) {
        var layers = e.layers;
        var type = e.layerType;

        layers.eachLayer(function (layer) {
            console.log(layer)
        })

    })

    function updatePolygonTable() {
        var tableBody = document.getElementById('polygonTableBody');
        tableBody.innerHTML = ''; // Clear the table body before updating

        // Loop through the drawnPolygons array and populate the table rows
        drawnPolygons.forEach(function (polygon) {
            var row = document.createElement('tr');

            var idCell = document.createElement('td');
            idCell.textContent = polygon.id;

            var typeCell = document.createElement('td');
            typeCell.textContent = polygon.name;

            var concentrationCell = document.createElement('td');
            concentrationCell.textContent = polygon.concentration;

            var colorCell = document.createElement('td');
            colorCell.style.backgroundColor = polygon.layer.options.color;

            var actionsCell = document.createElement('td');
            var editButton = document.createElement('button');
            editButton.textContent = 'Ред.';
            editButton.addEventListener('click', function () {
                openModal(polygon.id);
            });
            actionsCell.appendChild(editButton);

            var actionsCell2 = document.createElement('td'); // Use a different variable name
            var deleteButton = document.createElement('button');
            deleteButton.textContent = 'Вид.';
            deleteButton.addEventListener('click', function () {
                deletePolygon(polygon.id);
            });
            actionsCell2.appendChild(deleteButton); // Use the correct variable name here

            row.appendChild(idCell);
            row.appendChild(typeCell);
            row.appendChild(concentrationCell);
            row.appendChild(colorCell);
            row.appendChild(actionsCell);
            row.appendChild(actionsCell2);

            tableBody.appendChild(row);
        });
    }

    function openModal(polygonId) {

        var polygon = drawnPolygons.find(function (p) {
            return p.id === polygonId;
        });

        if (polygon) {

            var myModal = new bootstrap.Modal(document.getElementById('staticBackdrop'));
            myModal.show();

            //update ID to track it in modal window
            poligonIdEdit = polygonId;

        }

    }

    function deletePolygon(polygonId) {

        var polygon = drawnPolygons.find(function (p) {
            return p.id === polygonId;
        });

        if (polygon) {

            polygon.layer.remove();
            drawnPolygons.splice(polygonId, 1);

            updatePolygonTable();

        }

    }

    document.addEventListener('DOMContentLoaded', function () {
        // Get a reference to the "Save" button
        var saveButton = document.getElementById('saveButton');
        var cancelButton = document.getElementById('cancelButton');

        // Add click event listener to the "Save" button
        saveButton.addEventListener('click', function () {
            // Call your function or perform the desired action here
            saveChanges();
        });

        cancelButton.addEventListener('click', function () {
            cancelChanges();
        });

    });

    // Function to be executed when the "Save" button is clicked
    function saveChanges() {
        // Perform your save operation here

        var polygon = drawnPolygons.find(function (p) {
            return p.id === poligonIdEdit;
        });

        if (polygon) {

            var e = document.getElementById("inputTypeDanger");
            var type = e.options[e.selectedIndex].text;

            var b = document.getElementById("concentrationInput");
            var value = b.value;

            var c = document.getElementById("colorInput");
            var newColor = c.value;

            polygon.name = type;
            polygon.layer.name = type + " " + value;
            polygon.concentration = value;
            //polygon.layer.options.color = color;
            polygon.layer.setStyle({ color: newColor });

            

            polygon.color = newColor;

            polygon.layer.redraw();

            //polygon.layer.bindPopup(`<p>${polygon.layer.name}</p>`)
            polygon.layer.bindPopup(`<p>${polygon.layer.name}<br>${JSON.stringify(polygon.layer.toGeoJSON())}</p>`);


            updatePolygonTable();


        }

        var modalElement = document.getElementById("staticBackdrop");
        var modal = bootstrap.Modal.getInstance(modalElement);
        modal.hide();

        poligonIdEdit = -1;
    }

    function cancelChanges() {
        var modalElement = document.getElementById("staticBackdrop");
        var modal = bootstrap.Modal.getInstance(modalElement);
        modal.hide();

        poligonIdEdit = -1;
    }



</script>